<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CatÃ¡logo Tyson Autoparts</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar">
    <h1>Tyson Autoparts</h1>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="catalog.html">CatÃ¡logo</a></li>
        <li><a href="contact.html">Contacto</a></li>
      </ul>
    </nav>
    <div class="searchbar">
      <input id="search" type="text" placeholder="Buscar autoparte..." />
      <select id="categoria">
        <option value="">Todas</option>
      </select>
    </div>
  </header>

  <main class="vitrina">
    <!-- Banner -->
    <div class="banner">
      <h2>Tyson Autoparts</h2>
      <p>Encuentra la pieza que necesitas</p>
    </div>

    <!-- Piezas destacadas -->
    <section id="destacados" class="grid"></section>

    <!-- Bloque de confianza -->
    <section class="confianza">
      <h2>Compra con confianza</h2>
      <!-- ... resto de tus secciones de confianza ... -->
    </section>

    <!-- Contacto lateral -->
    <aside class="contacto">
      <h3>Contacto directo</h3>
      <a class="wa-btn" href="https://wa.me/5216141315986" target="_blank">ðŸ“² WhatsApp</a>
      <a class="fb-btn" href="https://facebook.com/tysonautoparts" target="_blank">ðŸ”— Facebook</a>
    </aside>
  </main>

  <footer>
    <p>&copy; 2025 Tyson Autoparts | Bryan</p>
  </footer>

  <!-- Modal para imagen ampliada -->
  <div id="imgModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="imgGrande">
  </div>

  <script>
    const normalize = s => (s || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .trim();

    const stopWords = ["de","del","la","el","los","las","para","por","un","una"];
    let productos = [];

    function parseLine(line) {
      if (!line || !line.trim()) return null;
      const low = line.trim().toLowerCase();
      if (low.startsWith("titulo,descripcion,precio,estado,imagen,categoria")) return null;
      const cols = line.split(",").map(v => v.trim());
      while (cols.length < 6) cols.push("");
      return { titulo: cols[0], descripcion: cols[1], precio: cols[2], estado: cols[3], imagen: cols[4], categoria: cols[5] };
    }

    // Crear tarjeta con imagen ampliable y distintivo Mercado Libre
    function crearCard(row) {
      const est = (row.estado || "").trim().toUpperCase();
      if (est === "VENDIDA") return null;

      const card = document.createElement("div");
      card.className = "product-card";
      card.setAttribute("data-categoria", normalize(row.categoria));

      // Si es de Mercado Libre, agregamos clase especial
      if ((row.categoria || "").toLowerCase() === "mercadolibre") {
        card.classList.add("mercadolibre");
      }

      const precioTxt = row.precio ? `$${row.precio}` : "â€”";
      const imgHtml = row.imagen
        ? `<img src="${row.imagen}" alt="${row.titulo}" onclick="activarModalImagen(this)">`
        : `<div class="placeholder">Sin imagen</div>`;

      card.innerHTML = `
        ${imgHtml}
        <div class="product-info">
          <h3>${row.titulo}</h3>
          ${row.descripcion ? `<p class="descripcion">${row.descripcion}</p>` : ""}
          <p class="precio">${precioTxt}</p>
          <span class="estado-disponible">âœ… Disponible</span>
          <a class="wa-btn" href="https://wa.me/5216141315986?text=Hola%20quiero%20informaciÃ³n%20sobre%20${encodeURIComponent(row.titulo)}" target="_blank">ðŸ“² Comprar por WhatsApp</a>
        </div>
      `;
      return card;
    }

    // FunciÃ³n para abrir imagen en grande
    function activarModalImagen(imgElement) {
      const modal = document.getElementById("imgModal");
      const imgGrande = document.getElementById("imgGrande");
      modal.style.display = "block";
      imgGrande.src = imgElement.src;
    }

    function aplicarFiltros() {
      const term = normalize(document.getElementById("search").value);
      const catFilter = document.getElementById("categoria").value;
      const words = term.split(/\s+/).filter(w => w && !stopWords.includes(w));

      const container = document.getElementById("destacados");
      container.innerHTML = "";

      let filtrados = productos.filter(row => {
        const text = normalize(`${row.titulo} ${row.descripcion} ${row.categoria}`);
        const cat = normalize(row.categoria);

        const matchText = words.length === 0 ? true : words.every(w => text.includes(w));
        const matchCat = !catFilter || cat === catFilter;

        return matchText && matchCat && (row.estado || "").toUpperCase() !== "VENDIDA";
      });

      filtrados.forEach(row => {
        const card = crearCard(row);
        if (card) container.appendChild(card);
      });
    }

    // Cargar productos manuales
    fetch("catalogo.csv")
      .then(r => r.text())
      .then(raw => {
        const lines = raw.split(/\r?\n/);
        lines.forEach(line => {
          const obj = parseLine(line);
          if (obj && obj.titulo) productos.push(obj);
        });

        // Cargar productos de Mercado Libre
        fetch("https://tyson-autopartes.vercel.app/api/items")
          .then(r => r.json())
          .then(data => {
            if (!data.items || !Array.isArray(data.items)) return;

            data.items.forEach(item => {
              productos.push({
                titulo: item.titulo,
                descripcion: "Publicado en Mercado Libre",
                precio: item.precio,
                estado: "ACTIVA",
                imagen: item.imagen,
                categoria: "mercadolibre"
              });
            });

            aplicarFiltros();
          })
          .catch(err => console.error("Error cargando productos Mercado Libre:", err));

        // Mostrar piezas aleatorias al inicio
        const container = document.getElementById("destacados");
        const disponibles = productos.filter(p => (p.estado || "").toUpperCase() !== "VENDIDA");
        const mezclados = disponibles.sort(() => Math.random() - 0.5);
        const visibles = mezclados.slice(0, 5);

        visibles.forEach(row => {
          const card = crearCard(row);
          if (card) container.appendChild(card);
        });

        // Poblar categorÃ­as
        const select = document.getElementById("categoria");
        const set = new Set(productos.map(p => normalize(p.categoria)).filter(Boolean));
        [...set].sort().forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
          select.appendChild(opt);
        });

        // Activar filtros
        document.getElementById("search").addEventListener("input", aplicarFiltros);
        document.getElementById("categoria").addEventListener("change", aplicarFiltros);
      })
      .catch(err => console.error("Error cargando catalogo.csv:", err));

    // Cerrar modal
    document.querySelector(".close").onclick = function() {
      document.getElementById("imgModal").style.display = "none";
    };
    document.getElementById("imgModal").onclick = function(e) {
      if (e.target.id === "imgModal") {
        document.getElementById("imgModal").style.display = "none";
      }
    };
  </script>
</body>
</html>
